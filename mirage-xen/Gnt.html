<div class="ocaml_top"><div class="ocaml_summary"><div class="info">Allow a local xen domain to read/write memory exported (&quot;granted&quot;)
from foreign domains. Safe memory sharing is a building block of all
xen inter-domain communication protocols such as those for virtual
network and disk devices.<p>Foreign domains will explicitly &quot;grant&quot; us access to certain memory
regions such as disk buffers. These regions are uniquely identified
by the pair of (foreign domain id, integer reference) which is
passed to us over some existing channel (typically via xenstore keys
or via structures in previously-shared memory region).</p></div></div>
<div class="ocaml_content"><div class="info"><h2 id="2_TITLE">Common interface</h2></div>
<pre class="odoccode"><span class="TYPEgntref"><span class="keyword">type</span> gntref</span> = <code class="type">int</code></pre><div class="info">Type of a grant table index, called a grant reference in
Xen's terminology.</div>
<div class="info"><h2 id="2_TITLE">Receiving foreign pages</h2></div>
<div class="ocaml_module" name="Gnttab"><pre class="odoccode"><span class="keyword">module</span> <a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab" class="ocaml_internal">Gnttab</a> : <code class="type"><code class="code">sig</code> .. <code class="code">end</code></code></pre><div class="ocaml_summary"/><div class="ocaml_content">
<pre class="odoccode"><span class="TYPEinterface"><span class="keyword">type</span> interface</span></pre><div class="info">A connection to the grant device, needed for mapping/unmapping.</div>
<pre class="odoccode"><span class="VALinterface_open"><span class="keyword">val</span> interface_open</span> : <code class="type">unit -&gt; <a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.interface" class="ocaml_internal">interface</a></code></pre><div class="info">Open a connection to the grant device. This must be done before any
calls to map or unmap.</div>
<pre class="odoccode"><span class="VALinterface_close"><span class="keyword">val</span> interface_close</span> : <code class="type"><a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.interface" class="ocaml_internal">interface</a> -&gt; unit</code></pre><div class="info">Close a connection to the grant device. Any future calls to map or
unmap will fail.</div>
<pre class="odoccode"><code><span class="TYPEgrant"><span class="keyword">type</span> grant</span> = {</code></pre><table class="typetable">
		    <tr><td align="left" valign="top"><code>  </code></td><td align="left" valign="top"><code><span class="TYPEELTgrant.domid">domid</span> : <code class="type">int</code>;</code></td><td class="typefieldcomment" align="left"><div class="info">foreign domain who is exporting memory</div></td></tr><tr><td align="left" valign="top"><code>  </code></td><td align="left" valign="top"><code><span class="TYPEELTgrant.ref">ref</span> : <code class="type"><a href="http://mirage.github.io/mirage-xen/#Gnt.gntref" class="ocaml_internal">gntref</a></code>;</code></td><td class="typefieldcomment" align="left"><div class="info">id which identifies the specific export in the foreign domain</div></td></tr><tr><td>}</td></tr></table><div class="info">A foreign domain must explicitly &quot;grant&quot; us memory and send us the
&quot;reference&quot;. The pair of (foreign domain id, reference) uniquely
identifies the block of memory. This pair (&quot;grant&quot;) is transmitted
to us out-of-band, usually either via xenstore during device setup or
via a shared memory ring structure.</div>
<div class="ocaml_module" name="Local_mapping"><pre class="odoccode"><span class="keyword">module</span> <a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.Local_mapping" class="ocaml_internal">Local_mapping</a> : <code class="type"><code class="code">sig</code> .. <code class="code">end</code></code></pre><div class="ocaml_summary"/><div class="ocaml_content">
<pre class="odoccode"><span class="TYPEt"><span class="keyword">type</span> t</span></pre><div class="info">Abstract type representing locally-mapped shared memory
pages.</div>
<pre class="odoccode"><span class="VALto_buf"><span class="keyword">val</span> to_buf</span> : <code class="type"><a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.Local_mapping.t" class="ocaml_internal">t</a> -&gt; <a href="http://mirage.github.io/io-page-xen/#Io_page.t">Io_page.t</a></code></pre></div></div>
<pre class="odoccode"><span class="VALmap_exn"><span class="keyword">val</span> map_exn</span> : <code class="type"><a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.interface" class="ocaml_internal">interface</a> -&gt; <a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.grant" class="ocaml_internal">grant</a> -&gt; bool -&gt; <a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.Local_mapping.t" class="ocaml_internal">Local_mapping.t</a></code></pre><div class="info"><code class="code">map_exn if grant writeable</code> creates a single mapping from a grant
using that will be writeable if <code class="code">writeable</code> is <code class="code">true</code>.</div>
<pre class="odoccode"><span class="VALmap"><span class="keyword">val</span> map</span> : <code class="type"><a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.interface" class="ocaml_internal">interface</a> -&gt; <a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.grant" class="ocaml_internal">grant</a> -&gt; bool -&gt; <a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.Local_mapping.t" class="ocaml_internal">Local_mapping.t</a> option</code></pre><div class="info">Like the above but return an option instead of raising an
exception.</div>
<pre class="odoccode"><span class="VALmapv_exn"><span class="keyword">val</span> mapv_exn</span> : <code class="type"><a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.interface" class="ocaml_internal">interface</a> -&gt; <a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.grant" class="ocaml_internal">grant</a> list -&gt; bool -&gt; <a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.Local_mapping.t" class="ocaml_internal">Local_mapping.t</a></code></pre><div class="info"><code class="code">mapv_exn if grants writeable</code> creates a single contiguous
mapping from a list of grants that will be writeable if
<code class="code">writeable</code> is <code class="code">true</code>. Note the grant list can involve grants
from multiple domains. If the mapping fails (because at least
one grant fails to be mapped), then all grants are unmapped.</div>
<pre class="odoccode"><span class="VALmapv"><span class="keyword">val</span> mapv</span> : <code class="type"><a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.interface" class="ocaml_internal">interface</a> -&gt; <a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.grant" class="ocaml_internal">grant</a> list -&gt; bool -&gt; <a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.Local_mapping.t" class="ocaml_internal">Local_mapping.t</a> option</code></pre><div class="info">Like the above but return an option instead of raising an
exception.</div>
<pre class="odoccode"><span class="VALunmap_exn"><span class="keyword">val</span> unmap_exn</span> : <code class="type"><a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.interface" class="ocaml_internal">interface</a> -&gt; <a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.Local_mapping.t" class="ocaml_internal">Local_mapping.t</a> -&gt; unit</code></pre><div class="info">Attempt to unmap a local mapping. Throws a Failure exception if
unsuccessful.</div>
<div class="info"><h2 id="2_TITLE">Xen specific functions</h2></div>
<pre class="odoccode"><span class="VALwith_mapping"><span class="keyword">val</span> with_mapping</span> : <code class="type"><a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.interface" class="ocaml_internal">interface</a> -&gt;
<a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.grant" class="ocaml_internal">grant</a> -&gt; bool -&gt; (<a href="http://mirage.github.io/mirage-xen/#Gnt.Gnttab.Local_mapping.t" class="ocaml_internal">Local_mapping.t</a> option -&gt; 'a <a href="http://mirage.github.io/lwt/#Lwt.t">Lwt.t</a>) -&gt; 'a <a href="http://mirage.github.io/lwt/#Lwt.t">Lwt.t</a></code></pre><div class="info"><code class="code">with_mapping if grant writeable f</code> maps <code class="code">grant</code> and calls <code class="code">f</code> on
the result.</div></div></div>
<div class="info"><h2 id="2_TITLE">Offering pages to foreign domains</h2></div>
<div class="ocaml_module" name="Gntshr"><pre class="odoccode"><span class="keyword">module</span> <a href="http://mirage.github.io/mirage-xen/#Gnt.Gntshr" class="ocaml_internal">Gntshr</a> : <code class="type"><code class="code">sig</code> .. <code class="code">end</code></code></pre><div class="ocaml_summary"/><div class="ocaml_content">
<pre class="odoccode"><span class="TYPEinterface"><span class="keyword">type</span> interface</span></pre><div class="info">A connection to the grant device, needed for mapping/unmapping.</div>
<pre class="odoccode"><span class="VALinterface_open"><span class="keyword">val</span> interface_open</span> : <code class="type">unit -&gt; <a href="http://mirage.github.io/mirage-xen/#Gnt.Gntshr.interface" class="ocaml_internal">interface</a></code></pre><div class="info">Open a connection to the grant device. This must be done before any
calls to map or unmap.</div>
<pre class="odoccode"><span class="VALinterface_close"><span class="keyword">val</span> interface_close</span> : <code class="type"><a href="http://mirage.github.io/mirage-xen/#Gnt.Gntshr.interface" class="ocaml_internal">interface</a> -&gt; unit</code></pre><div class="info">Close a connection to the grant device. Any future calls to map or
unmap will fail.</div>
<pre class="odoccode"><code><span class="TYPEshare"><span class="keyword">type</span> share</span> = {</code></pre><table class="typetable">
		    <tr><td align="left" valign="top"><code>  </code></td><td align="left" valign="top"><code><span class="TYPEELTshare.refs">refs</span> : <code class="type"><a href="http://mirage.github.io/mirage-xen/#Gnt.gntref" class="ocaml_internal">gntref</a> list</code>;</code></td><td class="typefieldcomment" align="left"><div class="info">List of grant references which have been shared with a foreign
domain.</div></td></tr><tr><td align="left" valign="top"><code>  </code></td><td align="left" valign="top"><code><span class="TYPEELTshare.mapping">mapping</span> : <code class="type"><a href="http://mirage.github.io/io-page-xen/#Io_page.t">Io_page.t</a></code>;</code></td><td class="typefieldcomment" align="left"><div class="info">Mapping of the shared memory.</div></td></tr><tr><td>}</td></tr></table><div class="info">When sharing a number of pages with another domain, we receive
back both the list of grant references shared and actually
mapped page(s). The foreign domain can map the same shared
memory, after being notified (e.g. via xenstore) of our domid
and list of references.</div>
<pre class="odoccode"><span class="VALshare_pages_exn"><span class="keyword">val</span> share_pages_exn</span> : <code class="type"><a href="http://mirage.github.io/mirage-xen/#Gnt.Gntshr.interface" class="ocaml_internal">interface</a> -&gt; int -&gt; int -&gt; bool -&gt; <a href="http://mirage.github.io/mirage-xen/#Gnt.Gntshr.share" class="ocaml_internal">share</a></code></pre><div class="info"><code class="code">share_pages_exn if domid count writeable</code> shares <code class="code">count</code> pages
with foreign domain <code class="code">domid</code>. <code class="code">writeable</code> determines whether or
not the foreign domain can write to the shared memory.</div>
<pre class="odoccode"><span class="VALshare_pages"><span class="keyword">val</span> share_pages</span> : <code class="type"><a href="http://mirage.github.io/mirage-xen/#Gnt.Gntshr.interface" class="ocaml_internal">interface</a> -&gt; int -&gt; int -&gt; bool -&gt; <a href="http://mirage.github.io/mirage-xen/#Gnt.Gntshr.share" class="ocaml_internal">share</a> option</code></pre><div class="info"><code class="code">share_pages if domid count writeable</code> shares <code class="code">count</code> pages with
foreign domain <code class="code">domid</code>. <code class="code">writeable</code> determines whether or not
the foreign domain can write to the shared memory. On error
this function returns None. Diagnostic details will be
logged.</div>
<pre class="odoccode"><span class="VALmunmap_exn"><span class="keyword">val</span> munmap_exn</span> : <code class="type"><a href="http://mirage.github.io/mirage-xen/#Gnt.Gntshr.interface" class="ocaml_internal">interface</a> -&gt; <a href="http://mirage.github.io/mirage-xen/#Gnt.Gntshr.share" class="ocaml_internal">share</a> -&gt; unit</code></pre><div class="info">Unmap a single mapping (which may involve multiple grants)</div>
<div class="info"><h2 id="2_TITLE">Xen specific functions</h2></div>
<pre class="odoccode"><span class="VALput"><span class="keyword">val</span> put</span> : <code class="type"><a href="http://mirage.github.io/mirage-xen/#Gnt.gntref" class="ocaml_internal">gntref</a> -&gt; unit</code></pre>
<pre class="odoccode"><span class="VALget"><span class="keyword">val</span> get</span> : <code class="type">unit -&gt; <a href="http://mirage.github.io/mirage-xen/#Gnt.gntref" class="ocaml_internal">gntref</a> <a href="http://mirage.github.io/lwt/#Lwt.t">Lwt.t</a></code></pre>
<pre class="odoccode"><span class="VALget_n"><span class="keyword">val</span> get_n</span> : <code class="type">int -&gt; <a href="http://mirage.github.io/mirage-xen/#Gnt.gntref" class="ocaml_internal">gntref</a> list <a href="http://mirage.github.io/lwt/#Lwt.t">Lwt.t</a></code></pre>
<pre class="odoccode"><span class="VALget_nonblock"><span class="keyword">val</span> get_nonblock</span> : <code class="type">unit -&gt; <a href="http://mirage.github.io/mirage-xen/#Gnt.gntref" class="ocaml_internal">gntref</a> option</code></pre><div class="info"><code class="code">get_nonblock ()</code> is <code class="code">Some idx</code> is the grant table is not full,
or <code class="code">None</code> otherwise.</div>
<pre class="odoccode"><span class="VALget_n_nonblock"><span class="keyword">val</span> get_n_nonblock</span> : <code class="type">int -&gt; <a href="http://mirage.github.io/mirage-xen/#Gnt.gntref" class="ocaml_internal">gntref</a> list</code></pre><div class="info"><code class="code">get_n_nonblock count</code> is a list of grant table indices of
length <code class="code">count</code>, or <code class="code">[]</code> if there if the table is too full to
accomodate <code class="code">count</code> new grant references.</div>
<pre class="odoccode"><span class="VALnum_free_grants"><span class="keyword">val</span> num_free_grants</span> : <code class="type">unit -&gt; int</code></pre>
<pre class="odoccode"><span class="VALwith_ref"><span class="keyword">val</span> with_ref</span> : <code class="type">(<a href="http://mirage.github.io/mirage-xen/#Gnt.gntref" class="ocaml_internal">gntref</a> -&gt; 'a <a href="http://mirage.github.io/lwt/#Lwt.t">Lwt.t</a>) -&gt; 'a <a href="http://mirage.github.io/lwt/#Lwt.t">Lwt.t</a></code></pre>
<pre class="odoccode"><span class="VALwith_refs"><span class="keyword">val</span> with_refs</span> : <code class="type">int -&gt; (<a href="http://mirage.github.io/mirage-xen/#Gnt.gntref" class="ocaml_internal">gntref</a> list -&gt; 'a <a href="http://mirage.github.io/lwt/#Lwt.t">Lwt.t</a>) -&gt; 'a <a href="http://mirage.github.io/lwt/#Lwt.t">Lwt.t</a></code></pre>
<pre class="odoccode"><span class="VALgrant_access"><span class="keyword">val</span> grant_access</span> : <code class="type">domid:int -&gt; writeable:bool -&gt; <a href="http://mirage.github.io/mirage-xen/#Gnt.gntref" class="ocaml_internal">gntref</a> -&gt; <a href="http://mirage.github.io/io-page-xen/#Io_page.t">Io_page.t</a> -&gt; unit</code></pre><div class="info"><code class="code">grant_access ~domid ~writeable gntref page</code> adds a grant table
entry at index <code class="code">gntref</code> to the grant table, granting access to
<code class="code">domid</code> to read <code class="code">page</code>, and write to is as well if <code class="code">writeable</code> is
<code class="code">true</code>.</div>
<pre class="odoccode"><span class="VALend_access"><span class="keyword">val</span> end_access</span> : <code class="type"><a href="http://mirage.github.io/mirage-xen/#Gnt.gntref" class="ocaml_internal">gntref</a> -&gt; unit</code></pre><div class="info"><code class="code">end_access gntref</code> removes entry index <code class="code">gntref</code> from the grant
table.</div>
<pre class="odoccode"><span class="VALwith_grant"><span class="keyword">val</span> with_grant</span> : <code class="type">domid:int -&gt;
writeable:bool -&gt; <a href="http://mirage.github.io/mirage-xen/#Gnt.gntref" class="ocaml_internal">gntref</a> -&gt; <a href="http://mirage.github.io/io-page-xen/#Io_page.t">Io_page.t</a> -&gt; (unit -&gt; 'a <a href="http://mirage.github.io/lwt/#Lwt.t">Lwt.t</a>) -&gt; 'a <a href="http://mirage.github.io/lwt/#Lwt.t">Lwt.t</a></code></pre>
<pre class="odoccode"><span class="VALwith_grants"><span class="keyword">val</span> with_grants</span> : <code class="type">domid:int -&gt;
writeable:bool -&gt;
<a href="http://mirage.github.io/mirage-xen/#Gnt.gntref" class="ocaml_internal">gntref</a> list -&gt; <a href="http://mirage.github.io/io-page-xen/#Io_page.t">Io_page.t</a> list -&gt; (unit -&gt; 'a <a href="http://mirage.github.io/lwt/#Lwt.t">Lwt.t</a>) -&gt; 'a <a href="http://mirage.github.io/lwt/#Lwt.t">Lwt.t</a></code></pre></div></div>
<div class="info"><h2 id="2_TITLE">Xen specific functions</h2></div>
<pre class="odoccode"><span class="VALconsole"><span class="keyword">val</span> console</span> : <code class="type"><a href="http://mirage.github.io/mirage-xen/#Gnt.gntref" class="ocaml_internal">gntref</a></code></pre><div class="info">In xen-4.2 and later, the domain builder will allocate one of the
reserved grant table entries and use it to pre-authorise the console
backend domain.</div>
<pre class="odoccode"><span class="VALxenstore"><span class="keyword">val</span> xenstore</span> : <code class="type"><a href="http://mirage.github.io/mirage-xen/#Gnt.gntref" class="ocaml_internal">gntref</a></code></pre><div class="info">In xen-4.2 and later, the domain builder will allocate one of the
reserved grant table entries and use it to pre-authorise the xenstore
backend domain.</div>
<div class="info">Functions called by <code class="code">Sched</code>, do not call directly.</div>
<pre class="odoccode"><span class="VALsuspend"><span class="keyword">val</span> suspend</span> : <code class="type">unit -&gt; unit</code></pre>
<pre class="odoccode"><span class="VALresume"><span class="keyword">val</span> resume</span> : <code class="type">unit -&gt; unit</code></pre>
</div></div>